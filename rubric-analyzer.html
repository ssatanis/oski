<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Rubric Analyzer - Oski</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .upload-section {
            padding: 40px;
            border-bottom: 2px solid #f0f0f0;
        }

        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8f9ff;
        }

        .upload-zone:hover {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: translateY(-2px);
        }

        .upload-zone.dragover {
            border-color: #4CAF50;
            background: #f0fff0;
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text h3 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-text p {
            color: #666;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .selected-files {
            margin-top: 30px;
        }

        .file-list {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .file-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            color: #667eea;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .file-size {
            color: #666;
            font-size: 0.9rem;
        }

        .remove-file {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .remove-file:hover {
            background: #ff3838;
        }

        .analysis-section {
            padding: 40px;
            display: none;
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .analysis-title {
            font-size: 2rem;
            color: #333;
        }

        .analysis-stats {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            min-width: 120px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .rubric-container {
            margin-top: 30px;
        }

        .rubric-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .rubric-title {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .rubric-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .detail-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .detail-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .assessment-domains {
            display: grid;
            gap: 25px;
        }

        .domain {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .domain-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .domain-name {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .domain-points {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .domain-description {
            color: rgba(255,255,255,0.9);
            font-size: 0.95rem;
            margin-top: 8px;
        }

        .criteria-list {
            padding: 0;
        }

        .criterion {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .criterion:last-child {
            border-bottom: none;
        }

        .criterion-number {
            background: #667eea;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .criterion-content {
            flex: 1;
        }

        .criterion-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .criterion-description {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .criterion-category {
            background: #f0f2ff;
            color: #667eea;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 8px;
            display: inline-block;
        }

        .points-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .points-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .points-btn:hover {
            background: #5a6fd8;
            transform: scale(1.1);
        }

        .points-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .points-display {
            background: #f8f9ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 8px 15px;
            font-weight: 600;
            color: #333;
            min-width: 50px;
            text-align: center;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2rem;
            color: #667eea;
            font-weight: 600;
        }

        .loading-details {
            color: #666;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .error-message {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            color: #c53030;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .success-message {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #276749;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .success-message.active {
            display: block;
        }

        .total-score {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-top: 30px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .export-controls {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .upload-section {
                padding: 20px;
            }
            
            .analysis-section {
                padding: 20px;
            }
            
            .analysis-stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .criterion {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .points-control {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üè• Comprehensive Rubric Analyzer</h1>
            <p>Upload medical assessment rubrics and convert them to interactive formats using advanced OCR and AI</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">
                    <h3>Upload Your Rubrics</h3>
                    <p>Drop files here or click to browse. Supports PDF, Excel (.xlsx/.xls), and Word (.docx/.doc) documents.</p>
                    <button class="btn" onclick="document.getElementById('fileInput').click()">
                        Choose Files
                    </button>
                </div>
            </div>
            
            <input type="file" id="fileInput" class="file-input" multiple 
                   accept=".pdf,.xlsx,.xls,.docx,.doc">
            
            <div class="selected-files" id="selectedFiles" style="display: none;">
                <h3>Selected Files:</h3>
                <div class="file-list" id="fileList"></div>
                <button class="btn" id="analyzeBtn" onclick="analyzeFiles()" style="margin-top: 20px;">
                    üîç Analyze Rubrics
                </button>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text">Analyzing Your Rubrics...</div>
            <div class="loading-details">
                Processing with advanced OCR engines (Tesseract, AWS Textract, Google Vision)
            </div>
        </div>

        <!-- Error/Success Messages -->
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <!-- Analysis Section -->
        <div class="analysis-section" id="analysisSection">
            <div class="analysis-header">
                <h2 class="analysis-title">üìä Analysis Results</h2>
                <div class="analysis-stats" id="analysisStats">
                    <!-- Stats will be populated here -->
                </div>
            </div>

            <div class="rubric-container" id="rubricContainer">
                <!-- Rubric content will be populated here -->
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let analysisResult = null;
        let currentRubric = null;

        // File upload handling
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const selectedFilesDiv = document.getElementById('selectedFiles');
        const fileList = document.getElementById('fileList');

        // Drag and drop handlers
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        uploadZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });

        function handleFiles(files) {
            // Add files to selection
            files.forEach(file => {
                if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    selectedFiles.push(file);
                }
            });

            updateFileDisplay();
        }

        function updateFileDisplay() {
            if (selectedFiles.length === 0) {
                selectedFilesDiv.style.display = 'none';
                return;
            }

            selectedFilesDiv.style.display = 'block';
            fileList.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const icon = getFileIcon(file.type);
                const size = formatFileSize(file.size);
                
                fileItem.innerHTML = `
                    <div class="file-icon">${icon}</div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${size}</div>
                    </div>
                    <button class="remove-file" onclick="removeFile(${index})">Remove</button>
                `;
                
                fileList.appendChild(fileItem);
            });
        }

        function getFileIcon(type) {
            if (type.includes('pdf')) return 'üìÑ';
            if (type.includes('excel') || type.includes('spreadsheet') || type.includes('sheet')) return 'üìä';
            if (type.includes('word') || type.includes('document')) return 'üìù';
            return 'üìÅ';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileDisplay();
        }

        async function analyzeFiles() {
            if (selectedFiles.length === 0) {
                showError('Please select at least one file to analyze.');
                return;
            }

            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('analysisSection').style.display = 'none';
            hideMessages();

            try {
                // For multiple files, process one by one (backend currently handles single file)
                const results = [];
                
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    updateLoadingText(`Processing ${file.name}... Please wait.`);
                    
                    // Prepare form data for single file
                    const formData = new FormData();
                    formData.append('file', file);

                    // Send to rubrics-to-prompts backend
                    const response = await fetch('http://localhost:8000/upload-rubric', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.detail || result.message || 'Analysis failed');
                    }

                    // Direct result processing
                    results.push(result);
                }

                // Hide loading
                document.getElementById('loading').classList.remove('active');

                // Combine results if multiple files
                let finalResult;
                if (results.length === 1) {
                    finalResult = results[0];
                } else {
                    finalResult = combineMultipleResults(results);
                }

                // Store result and display
                analysisResult = finalResult;
                currentRubric = finalResult.interactiveRubric;
                displayAnalysisResults(finalResult);
                showSuccess(`Successfully analyzed ${selectedFiles.length} file(s)!`);

            } catch (error) {
                console.error('Analysis error:', error);
                document.getElementById('loading').classList.remove('active');
                showError(`Analysis failed: ${error.message}`);
            }
        }



        function combineMultipleResults(results) {
            // Combine multiple rubric results
            const combinedRubric = {
                rubric_info: {
                    title: "Combined Medical Assessment Rubrics",
                    station_info: {
                        station_number: "Multiple",
                        condition: "Multiple Conditions",
                        specialty: "General Medicine"
                    },
                    total_points: 0,
                    creation_timestamp: new Date().toISOString(),
                    source_files: results.length
                },
                assessment_domains: []
            };

            // Combine all domains
            const domainMap = new Map();
            
            results.forEach(result => {
                if (result.interactiveRubric?.assessment_domains) {
                    result.interactiveRubric.assessment_domains.forEach(domain => {
                        if (!domainMap.has(domain.name)) {
                            domainMap.set(domain.name, {
                                ...domain,
                                subcategories: []
                            });
                        }
                        
                        const existingDomain = domainMap.get(domain.name);
                        existingDomain.subcategories.push(...domain.subcategories);
                    });
                }
            });

            combinedRubric.assessment_domains = Array.from(domainMap.values());
            
            // Recalculate total points
            combinedRubric.rubric_info.total_points = combinedRubric.assessment_domains.reduce(
                (total, domain) => total + (domain.total_points || 0), 0
            );

            return {
                success: true,
                interactiveRubric: combinedRubric,
                processedFiles: results.length,
                timestamp: new Date().toISOString(),
                analysisResult: {
                    combined_analysis: {
                        total_files: results.length,
                        successful_extractions: results.length,
                        failed_extractions: 0,
                        merged_criteria: [],
                        confidence_scores: { overall_average: 95 }
                    }
                }
            };
        }

        function updateLoadingText(text) {
            const loadingDetails = document.querySelector('.loading-details');
            if (loadingDetails) {
                loadingDetails.textContent = text;
            }
        }

        function displayAnalysisResults(result) {
            // Show analysis section
            document.getElementById('analysisSection').style.display = 'block';

            // Update stats
            const statsDiv = document.getElementById('analysisStats');
            const stats = result.analysisResult.combined_analysis;
            
            statsDiv.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${stats.total_files}</div>
                    <div class="stat-label">Files Processed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.successful_extractions}</div>
                    <div class="stat-label">Successful</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.merged_criteria?.length || 0}</div>
                    <div class="stat-label">Criteria Found</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${Math.round(stats.confidence_scores?.overall_average || 0)}%</div>
                    <div class="stat-label">OCR Confidence</div>
                </div>
            `;

            // Display rubric
            displayRubric(result.interactiveRubric);
        }

        function displayRubric(rubric) {
            const container = document.getElementById('rubricContainer');
            
            container.innerHTML = `
                <div class="rubric-info">
                    <div class="rubric-title">${rubric.rubric_info.title}</div>
                    <div class="rubric-details">
                        <div class="detail-item">
                            <div class="detail-label">Station Number</div>
                            <div class="detail-value">${rubric.rubric_info.station_info?.station_number || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Specialty</div>
                            <div class="detail-value">${rubric.rubric_info.station_info?.specialty || 'General Medicine'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Points</div>
                            <div class="detail-value">${rubric.rubric_info.total_points}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Source Files</div>
                            <div class="detail-value">${rubric.rubric_info.source_files}</div>
                        </div>
                    </div>
                </div>

                <div class="assessment-domains">
                    ${rubric.assessment_domains.map(domain => createDomainHTML(domain)).join('')}
                </div>

                <div class="total-score">
                    <div>Current Total Score: <span id="currentTotalScore">0</span> / ${rubric.rubric_info.total_points}</div>
                </div>

                <div class="export-controls">
                    <button class="btn btn-secondary" onclick="exportToJSON()">üìÑ Export JSON</button>
                    <button class="btn btn-success" onclick="exportToYAML()">üìù Export YAML</button>
                    <button class="btn" onclick="exportToPDF()">üìã Export PDF</button>
                </div>
            `;

            updateTotalScore();
        }

        function createDomainHTML(domain) {
            return `
                <div class="domain">
                    <div class="domain-header">
                        <div>
                            <div class="domain-name">${domain.name}</div>
                            <div class="domain-description">${domain.description}</div>
                        </div>
                        <div class="domain-points">${domain.total_points} pts</div>
                    </div>
                    <div class="criteria-list">
                        ${domain.subcategories.map(criterion => createCriterionHTML(criterion)).join('')}
                    </div>
                </div>
            `;
        }

        function createCriterionHTML(criterion) {
            const isEditable = criterion.editable !== false;
            const currentPoints = criterion.current_points || 0;
            const maxPoints = criterion.points || 1;

            return `
                <div class="criterion">
                    <div class="criterion-number">${criterion.id}</div>
                    <div class="criterion-content">
                        <div class="criterion-name">${criterion.name}</div>
                        <div class="criterion-description">${criterion.description || ''}</div>
                        <div class="criterion-category">${criterion.category}</div>
                    </div>
                    <div class="points-control">
                        <button class="points-btn" onclick="adjustPoints(${criterion.id}, -1)" 
                                ${!isEditable || currentPoints === 0 ? 'disabled' : ''}>
                            ‚óÄ
                        </button>
                        <div class="points-display" id="points_${criterion.id}">${currentPoints}</div>
                        <button class="points-btn" onclick="adjustPoints(${criterion.id}, 1)" 
                                ${!isEditable || currentPoints >= maxPoints ? 'disabled' : ''}>
                            ‚ñ∂
                        </button>
                    </div>
                </div>
            `;
        }

        function adjustPoints(criterionId, change) {
            // Find the criterion in the rubric
            let criterion = null;
            for (const domain of currentRubric.assessment_domains) {
                const found = domain.subcategories.find(c => c.id === criterionId);
                if (found) {
                    criterion = found;
                    break;
                }
            }

            if (!criterion) return;

            const currentPoints = criterion.current_points || 0;
            const maxPoints = criterion.points || 1;
            const newPoints = Math.max(0, Math.min(maxPoints, currentPoints + change));

            // Update the criterion
            criterion.current_points = newPoints;

            // Update the display
            const pointsDisplay = document.getElementById(`points_${criterionId}`);
            pointsDisplay.textContent = newPoints;

            // Update button states
            const decreaseBtn = pointsDisplay.previousElementSibling;
            const increaseBtn = pointsDisplay.nextElementSibling;
            
            decreaseBtn.disabled = newPoints === 0 || !criterion.editable;
            increaseBtn.disabled = newPoints >= maxPoints || !criterion.editable;

            // Update total score
            updateTotalScore();
        }

        function updateTotalScore() {
            let totalScore = 0;
            
            for (const domain of currentRubric.assessment_domains) {
                for (const criterion of domain.subcategories) {
                    totalScore += criterion.current_points || 0;
                }
            }

            document.getElementById('currentTotalScore').textContent = totalScore;
        }

        function calculateTotalScores() {
            const scores = {
                total: 0,
                domains: {}
            };

            for (const domain of currentRubric.assessment_domains) {
                let domainScore = 0;
                for (const criterion of domain.subcategories) {
                    domainScore += criterion.current_points || 0;
                }
                scores.domains[domain.name] = {
                    score: domainScore,
                    max_score: domain.total_points || 0
                };
                scores.total += domainScore;
            }

            return scores;
        }

        function exportToJSON() {
            const exportData = {
                rubric: currentRubric,
                scores: getCurrentScores(),
                exported_at: new Date().toISOString()
            };

            downloadFile(JSON.stringify(exportData, null, 2), 'rubric_analysis.json', 'application/json');
        }

        function exportToYAML() {
            if (!currentRubric) {
                showError('No rubric data available to export.');
                return;
            }

            try {
                console.log('üîÑ Generating YAML from current rubric...');
                
                const scores = getCurrentScores();
                
                // Generate comprehensive YAML content
                let yamlContent = `# Medical Assessment Rubric Export\n`;
                yamlContent += `# Generated on: ${new Date().toISOString()}\n\n`;
                
                yamlContent += `rubric_info:\n`;
                yamlContent += `  title: "${currentRubric.rubric_info.title}"\n`;
                yamlContent += `  station_number: "${currentRubric.rubric_info.station_info?.station_number || 'N/A'}"\n`;
                yamlContent += `  medical_condition: "${currentRubric.rubric_info.station_info?.condition || 'N/A'}"\n`;
                yamlContent += `  specialty: "${currentRubric.rubric_info.station_info?.specialty || 'General Medicine'}"\n`;
                yamlContent += `  total_possible_points: ${currentRubric.rubric_info.total_points}\n`;
                yamlContent += `  current_total_score: ${scores.total}\n`;
                yamlContent += `  completion_percentage: ${Math.round((scores.total / currentRubric.rubric_info.total_points) * 100)}%\n`;
                yamlContent += `  creation_timestamp: "${currentRubric.rubric_info.creation_timestamp}"\n\n`;

                yamlContent += `assessment_domains:\n`;
                
                for (const domain of currentRubric.assessment_domains) {
                    if (domain.subcategories && domain.subcategories.length > 0) {
                        const domainScore = scores.domains[domain.name]?.score || 0;
                        
                        yamlContent += `  - name: "${domain.name}"\n`;
                        yamlContent += `    description: "${domain.description}"\n`;
                        yamlContent += `    total_possible_points: ${domain.total_points || 0}\n`;
                        yamlContent += `    current_score: ${domainScore}\n`;
                        yamlContent += `    criteria:\n`;
                        
                        for (const criterion of domain.subcategories) {
                            yamlContent += `      - id: ${criterion.id}\n`;
                            yamlContent += `        name: "${criterion.name}"\n`;
                            yamlContent += `        category: "${criterion.category || 'General'}"\n`;
                            yamlContent += `        max_points: ${criterion.points}\n`;
                            yamlContent += `        current_points: ${criterion.current_points || 0}\n`;
                            yamlContent += `        description: "${criterion.description || criterion.name}"\n`;
                        }
                        yamlContent += `\n`;
                    }
                }

                // Add assessment summary
                yamlContent += `assessment_summary:\n`;
                yamlContent += `  domains_assessed: ${currentRubric.assessment_domains.length}\n`;
                yamlContent += `  total_criteria: ${currentRubric.assessment_domains.reduce((sum, domain) => sum + (domain.subcategories?.length || 0), 0)}\n`;
                yamlContent += `  export_timestamp: "${new Date().toISOString()}"\n`;

                console.log('‚úÖ YAML content generated successfully');
                
                // Generate filename based on rubric title
                const cleanTitle = currentRubric.rubric_info.title.replace(/[^a-zA-Z0-9]/g, '_');
                const filename = `${cleanTitle}_assessment.yaml`;
                
                downloadFile(yamlContent, filename, 'text/yaml');
                showSuccess('YAML file exported successfully!');
                
            } catch (error) {
                console.error('‚ùå Error generating YAML:', error);
                showError('Failed to export YAML file. Please try again.');
            }
        }

        function exportToPDF() {
            // For now, show a message about PDF export
            showSuccess('PDF export feature coming soon! Use JSON or YAML export for now.');
        }

        function getCurrentScores() {
            const scores = {
                total: 0,
                domains: {}
            };

            for (const domain of currentRubric.assessment_domains) {
                let domainScore = 0;
                const domainScores = [];
                
                for (const criterion of domain.subcategories) {
                    const score = criterion.current_points || 0;
                    domainScore += score;
                    domainScores.push({
                        id: criterion.id,
                        name: criterion.name,
                        score: score,
                        max_score: criterion.points
                    });
                }
                
                scores.domains[domain.name] = {
                    score: domainScore,
                    max_score: domain.total_points,
                    criteria: domainScores
                };
                scores.total += domainScore;
            }

            return scores;
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.add('active');
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.remove('active');
            document.getElementById('successMessage').classList.remove('active');
        }

        // Auto-hide messages after 5 seconds
        setInterval(() => {
            hideMessages();
        }, 5000);
    </script>
</body>
</html> 